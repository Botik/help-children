{% extends 'base.html.twig' %}

{% block body %}
    <!--<form action="https://wpay.uniteller.ru/pay/" method="POST">
        {% for key, value in fields %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endfor %}
    </form>-->
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://widget.cloudpayments.ru/bundles/cloudpayments"></script>
    <script type="text/javascript">
        $(function(){
            var widget = new cp.CloudPayments();

            var data = {
                email     : '{{ fields.Email }}',
                name      : '{{ fields.Name }}',
                lastname  : '{{ fields.LastName }}',
                firstname : '{{ fields.FirstName }}',
                phone     : '{{ fields.Phone }}'
            };
            {% if fields.IsRecurrentStart == 1 %}
            data.cloudPayments = {recurrent: { interval: 'Month', period: 1}}; //создание ежемесячной подписки
            {% endif %}

            var wopt   = {
                publicId    : 'pk_51de50fd3991dbf5b3610e65935d1',  //id из личного кабинета
                description : 'Благотворительная помощь', //назначение
                amount      : {{ fields.Subtotal_P }}, //сумма
                currency    : 'RUB', //валюта
                email       : '{{ fields.Email }}',
                invoiceId   : '{{ fields.Order_IDP }}', //номер заказа  (необязательно)
                accountId   : '{{ fields.Customer_IDP }}', //идентификатор плательщика (необязательно)
                skin        : "mini", //дизайн виджета
                data        : data
            };

            widget.charge(
                wopt,
                function (options) {
                    $.post('{{ fields.URL_RETURN_OK }}', {
                        'order_id': '{{ fields.Order_IDP }}'
                    }).success(function(ret){
                        window.location.href = '/account/history';
                    }).error(function (req) {
                        window.location.href = '/account/history';
                    });
                },
                function (reason, options) {
                    alert('Причина: ' + reason);
                    $.post('{{ fields.URL_RETURN_NO }}', {
                        'order_id': '{{ fields.Order_IDP }}'
                    }).success(function(ret){
                        window.location.href = '/account/history';
                    }).error(function (req) {
                        window.location.href = '/account/history';
                    });
                }
            );
        });
    </script>
{% endblock %}
